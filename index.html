<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Magnetic Search</title>
    <style>
        #start, #stop {
            margin: 10px;
            padding: 10px;
            font-size: 16px;
        }
        #chart {
            width: 100%;
            height: 300px;
        }
    </style>
</head>
<body>
    <h1>Magnetic Search</h1>
    <button id="start">Start</button>
    <button id="stop">Stop</button>
    <div id="chart"></div>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        let accelerometer = null;
        let magnetometer = null;
        let accelData = [];
        let magData = [];
        let intervalId = null;
        const magBuffer = [];

        const startButton = document.getElementById('start');
        const stopButton = document.getElementById('stop');

        const ctx = document.getElementById('chart').getContext('2d');
        const chart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: [],
                datasets: [
                    {
                        label: 'Magnetic X',
                        data: [],
                        borderColor: 'red',
                        fill: false,
                    },
                    {
                        label: 'Magnetic Y',
                        data: [],
                        borderColor: 'green',
                        fill: false,
                    },
                    {
                        label: 'Magnetic Z',
                        data: [],
                        borderColor: 'blue',
                        fill: false,
                    },
                ],
            },
            options: {
                scales: {
                    x: {
                        type: 'linear',
                        position: 'bottom',
                    },
                },
            },
        });

        async function startSensors() {
            try {
                accelerometer = new Accelerometer({ frequency: 60 });
                magnetometer = new Magnetometer({ frequency: 60 });

                accelerometer.addEventListener('reading', () => {
                    accelData.push({
                        x: accelerometer.x,
                        y: accelerometer.y,
                        z: accelerometer.z,
                        timestamp: Date.now(),
                    });
                });

                magnetometer.addEventListener('reading', () => {
                    const magEntry = {
                        x: magnetometer.x,
                        y: magnetometer.y,
                        z: magnetometer.z,
                        timestamp: Date.now(),
                    };
                    magData.push(magEntry);
                    magBuffer.push(magEntry);
                    if (magBuffer.length > 180) {
                        magBuffer.shift();
                    }
                    updateChart();
                });

                accelerometer.start();
                magnetometer.start();

                intervalId = setInterval(processMagData, 1000);
            } catch (error) {
                console.error('Sensor start error:', error);
            }
        }

        function stopSensors() {
            if (accelerometer) accelerometer.stop();
            if (magnetometer) magnetometer.stop();
            clearInterval(intervalId);
        }

        function updateChart() {
            const labels = magBuffer.map(entry => (entry.timestamp / 1000).toFixed(1));
            chart.data.labels = labels;
            chart.data.datasets[0].data = magBuffer.map(entry => entry.x);
            chart.data.datasets[1].data = magBuffer.map(entry => entry.y);
            chart.data.datasets[2].data = magBuffer.map(entry => entry.z);
            chart.update();
        }

        function processMagData() {
            if (magBuffer.length === 0) return;
            const last3SecData = magBuffer.filter(entry => entry.timestamp > Date.now() - 3000);
            const avgX = last3SecData.reduce((sum, entry) => sum + entry.x, 0) / last3SecData.length;
            const avgY = last3SecData.reduce((sum, entry) => sum + entry.y, 0) / last3SecData.length;
            const avgZ = last3SecData.reduce((sum, entry) => sum + entry.z, 0) / last3SecData.length;
            console.log('Average magnetic values for last 3 seconds:', { avgX, avgY, avgZ });
        }

        startButton.addEventListener('click', startSensors);
        stopButton.addEventListener('click', stopSensors);
    </script>
</body>
</html>
